<!DOCTYPE html>
<html>
<head>
	<title>ShareTargetPickerAgent</title>
	<meta charset="UTF-8" />
</head>

<body>
	<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
	<script>
		const proc = () => {
			const liff = window.liff;						
			liff.init({liffId: liffId})
			.then(() => {
				if (liff.isLoggedIn()) {
					if (liff.isApiAvailable('shareTargetPicker')) {
					  liff.shareTargetPicker(getMessage(bookName,album,cover,chp));
					}
				} else {
					liff.login({redirectUri:window.location.href});
				}
			})
			.catch(error => {
			});
		}
		
		const getMessage = (bookName,album,cover,chp)=>{
			return {			
			  "type": "flex",
			  "altText": "Flex Message",
			  "contents": {
				  "type": "bubble",
				  "body": {
					"type": "box",
					"layout": "vertical",
					"contents": [
					  {
						"type": "image",
						"url": cover,
						"size": "full",
						"aspectMode": "cover",
						"aspectRatio": "1:1.414",
						"gravity": "center",
						"action": {
						  "type": "uri",
						  "label": "action",
						  "uri": "https://script.google.com/a/g.ntu.edu.tw/macros/s/AKfycbz6EII_EOLzLO7D-xCT3eaLv0Zs_JSQ1tRSSgJom7u1EdOhRFw/exec?album="+album+"&title="+encodeURIComponent(chp)
						}
					  },
					  {
						"type": "box",
						"layout": "vertical",
						"contents": [],
						"position": "absolute",
						"background": {
						  "type": "linearGradient",
						  "angle": "0deg",
						  "endColor": "#00000000",
						  "startColor": "#00000099"
						},
						"width": "100%",
						"height": "40%",
						"offsetBottom": "0px",
						"offsetStart": "0px",
						"offsetEnd": "0px"
					  },
					  {
						"type": "box",
						"layout": "vertical",
						"contents": [
						  {
							"type": "text",
							"text": bookName,
							"size": "xl",
							"color": "#ffffff",
							"weight": "bold",
							"wrap": true
						  },
						  {
							"type": "text",
							"text": chp,
							"size": "md",
							"color": "#ffffff",
							"weight": "bold",
							"wrap": false,
							"adjustMode": "shrink-to-fit"
						  }
						],
						"position": "absolute",
						"paddingAll": "20px",
						"offsetBottom": "0px",
						"offsetStart": "0px",
						"offsetEnd": "0px"
					  }
					],
					"paddingAll": "0px"
				  }
				}
			};
		}
		
		let urlParams = new URLSearchParams(window.location.search);
		
		const params = urlParams.has('liff.state')? new URLSearchParams(urlParams.get('liff.state')) : urlParams;
		
		const liffId = params.get('liffId');
		const bookName = params.get('bookName');
		const album = params.get('album');
		const cover = params.get('cover');
		const chp = params.get('chp');
		
		proc();
		
	</script>
</body>

</html>